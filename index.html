<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Î”Î¿Ï…Î»ÎµÎ¹ÏÎ½ â€” Î¥Î»Î¹ÎºÎ¬ & ÎÏÎµÏ‚</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--panel2:#0b1220;--text:#e5e7eb;--muted:#9ca3af;--accent:#22d3ee;--border:#1f2937}
    *{box-sizing:border-box}
    body{margin:0;background:#0f172a;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#0f172a;border-bottom:1px solid var(--border);z-index:5}
    .container{max-width:1100px;margin:0 auto;padding:14px}
    h1{margin:6px 0 2px;font-size:22px}
    .sub{color:var(--muted);font-size:13px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:12px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    label{display:block;font-size:12px;color:var(--muted);margin:4px 0}
    input,textarea{width:100%;background:#0b1220;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 10px;font-size:14px}
    textarea{min-height:64px;resize:vertical}
    .btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    button{cursor:pointer;background:#0b1220;color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:999px;font-weight:600}
    button:hover{background:#10192e}
    .primary{background:linear-gradient(90deg,#22d3ee,#7c9cf1);border:none;color:#041016}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:6px 8px;font-size:14px;text-align:left;vertical-align:top}
    th{color:var(--muted);background:#0c1322;position:sticky;top:0}
    .right{text-align:right}
    .pill{font-size:12px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
    @media(max-width:900px){.row{grid-template-columns:repeat(6,1fr)}}
  </style>
</head>
<body>
<header>
  <div class="container">
    <h1>ğŸ“’ ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Î”Î¿Ï…Î»ÎµÎ¹ÏÎ½ â€” Î¥Î»Î¹ÎºÎ¬ & ÎÏÎµÏ‚</h1>
    <div class="sub">ÎÏÎ± Î­Î½Î±ÏÎ¾Î·Ï‚/Î»Î®Î¾Î·Ï‚ (Î±Ï…Ï„ÏŒÎ¼Î±Ï„ÎµÏ‚ ÏÏÎµÏ‚), Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï€ÎµÎ»Î±Ï„ÏÎ½/Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¹ÏÎ½, Ï…Î»Î¹ÎºÎ¬ Î±Î½Î¬ Î³ÏÎ±Î¼Î¼Î®, Î¦Î Î‘, ÏƒÏÎ½Î¿Î»Î±.</div>
  </div>
</header>

<main class="container">
  <section class="card" id="formCard">
    <div class="row">
      <div style="grid-column:span 3">
        <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
        <input type="date" id="date">
      </div>
      <div style="grid-column:span 3">
        <label>ÎÏÎ± ÎˆÎ½Î±ÏÎ¾Î·Ï‚</label>
        <input type="time" id="startTime" step="60">
      </div>
      <div style="grid-column:span 3">
        <label>ÎÏÎ± Î‘Ï€Î¿Ï€ÎµÏÎ¬Ï„Ï‰ÏƒÎ·Ï‚</label>
        <input type="time" id="endTime" step="60">
      </div>
      <div style="grid-column:span 3">
        <label>ÎÏÎµÏ‚ Î•ÏÎ³Î±ÏƒÎ¯Î±Ï‚ (Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î­Î½Î¿)</label>
        <input type="number" id="hours" step="0.1" min="0" placeholder="Ï€.Ï‡. 2.5">
      </div>

      <div style="grid-column:span 6">
        <label>Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
        <div style="display:flex; gap:8px">
          <input type="text" id="client" list="clientsList" placeholder="ÎŒÎ½Î¿Î¼Î± Ï€ÎµÎ»Î¬Ï„Î·" style="flex:1">
          <button type="button" id="saveClient" title="Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï€ÎµÎ»Î¬Ï„Î·">â­</button>
          <button type="button" id="manageClients" title="Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï€ÎµÎ»Î±Ï„ÏÎ½">ğŸ—‚ï¸</button>
        </div>
      </div>

      <div style="grid-column:span 6">
        <label>Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±</label>
        <div style="display:flex; gap:8px">
          <input type="text" id="location" list="locationsList" placeholder="Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î® Ï€ÎµÏÎ¹Î¿Ï‡Î®" style="flex:1">
          <button type="button" id="saveLocation" title="Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±Ï‚">â­</button>
          <button type="button" id="manageLocations" title="Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¹ÏÎ½">ğŸ—‚ï¸</button>
        </div>
      </div>

      <!-- Î»Î¯ÏƒÏ„ÎµÏ‚ Î³Î¹Î± autocomplete -->
      <datalist id="clientsList"></datalist>
      <datalist id="locationsList"></datalist>

      <div style="grid-column:span 12">
        <label>Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚ (Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î®)</label>
        <textarea id="task" placeholder="Î£ÏÎ½Ï„Î¿Î¼Î· Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î® ÎµÏÎ³Î±ÏƒÎ¹ÏÎ½..."></textarea>
      </div>

      <!-- Î¥Î»Î¹ÎºÎ¬ -->
      <div style="grid-column:span 12">
        <label>Î¥Î»Î¹ÎºÎ¬ (Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬)</label>
        <div style="overflow:auto;border:1px solid var(--border);border-radius:10px;">
          <table id="materialsTable">
            <thead>
              <tr>
                <th style="width:28px">#</th>
                <th>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</th>
                <th>Î Î¿Ïƒ.</th>
                <th>ÎœÎ¿Î½Î¬Î´Î±</th>
                <th class="right">Î¤Î¹Î¼Î® ÎœÎ¿Î½. (â‚¬)</th>
                <th class="right">Î“ÏÎ±Î¼Î¼Î® (â‚¬)</th>
                <th>Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td colspan="5" class="right"><b>Î£ÏÎ½Î¿Î»Î¿ Î¥Î»Î¹ÎºÏÎ½ (â‚¬)</b></td>
                <td class="right"><span id="materialsSum">0.00</span></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="btns" style="margin-top:6px">
          <button id="addMat">â• Î“ÏÎ±Î¼Î¼Î® Ï…Î»Î¹ÎºÎ¿Ï</button>
          <button id="clearMat">ğŸ§¹ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï…Î»Î¹ÎºÏÎ½</button>
        </div>
      </div>

      <!-- ÎšÏŒÏƒÏ„Î· & Î¦Î Î‘ -->
      <div style="grid-column:span 3">
        <label>ÎšÏŒÏƒÏ„Î¿Ï‚ Î•ÏÎ³Î±ÏƒÎ¯Î±Ï‚ (â‚¬)</label>
        <input type="number" id="labor" step="0.01" min="0" placeholder="0.00">
      </div>
      <div style="grid-column:span 3">
        <label>Î¦Î Î‘ (%)</label>
        <input type="number" id="vatRate" step="0.5" min="0" placeholder="24">
      </div>
      <div style="grid-column:span 3">
        <label>Î¥Ï€Î¿ÏƒÏÎ½Î¿Î»Î¿ (â‚¬)</label>
        <input type="number" id="subtotal" step="0.01" readonly>
      </div>
      <div style="grid-column:span 3">
        <label>Î¦Î Î‘ (â‚¬)</label>
        <input type="number" id="vatAmount" step="0.01" readonly>
      </div>
      <div style="grid-column:span 3">
        <label>Î£ÏÎ½Î¿Î»Î¿ (â‚¬) Î¼Îµ Î¦Î Î‘</label>
        <input type="number" id="grandTotal" step="0.01" readonly>
      </div>
      <div style="grid-column:span 3">
        <label>Î‘Ï. Î Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÎ¿Ï (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</label>
        <input type="text" id="invoice" placeholder="Ï€.Ï‡. Î¤Î Î¥-123">
      </div>
    </div>

    <div class="btns">
      <button class="primary" id="addBtn">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
      <button id="updateBtn" style="display:none">ğŸ’¾ Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·</button>
      <button id="clearFormBtn">ğŸ§¹ Î•ÎºÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎ· Ï†ÏŒÏÎ¼Î±Ï‚</button>
      <span class="pill" id="status">ÎˆÏ„Î¿Î¹Î¼Î¿</span>
    </div>
  </section>

  <!-- Î›Î¯ÏƒÏ„Î± -->
  <section class="card">
    <div style="overflow:auto;max-height:55vh;margin-top:8px;border:1px solid var(--border);border-radius:10px">
      <table id="table">
        <thead>
          <tr>
            <th>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th>
            <th>ÎˆÎ½Î±ÏÎ¾Î·</th>
            <th>Î›Î®Î¾Î·</th>
            <th>ÎÏÎµÏ‚</th>
            <th>Î ÎµÎ»Î¬Ï„Î·Ï‚</th>
            <th>Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±</th>
            <th>Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚</th>
            <th>Î•ÏÎ³Î±ÏƒÎ¯Î± (â‚¬)</th>
            <th>Î¥Î»Î¹ÎºÎ¬ (â‚¬)</th>
            <th>Î¥Ï€Î¿ÏƒÏÎ½Î¿Î»Î¿ (â‚¬)</th>
            <th>Î¦Î Î‘ (%)</th>
            <th>Î¦Î Î‘ (â‚¬)</th>
            <th>Î£ÏÎ½Î¿Î»Î¿ (â‚¬)</th>
            <th>Î Î±ÏÎ±ÏƒÏ„.</th>
            <th>Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Î“ÏÎ±Î¼Î¼Î® ÎµÏÎ³Î±Î»ÎµÎ¯Ï‰Î½ Î»Î¯ÏƒÏ„Î±Ï‚ -->
    <div class="btns" style="margin-top:10px">
      <button id="exportCsv">â¬‡ï¸ Î•Î¾Î±Î³Ï‰Î³Î® CSV</button>
      <button id="printList">ğŸ–¨ï¸ Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</button>
      <button id="backupJson">ğŸ’¾ Î‘Î½Ï„Î¯Î³ÏÎ±Ï†Î¿ (JSON)</button>
      <label class="pill" style="cursor:pointer">
        ğŸ“¤ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® JSON
        <input id="restoreJson" type="file" accept="application/json" style="display:none">
      </label>

      <span class="pill">Î£ÏÎ½Î¿Î»Î¿ ÎµÎ³Î³ÏÎ±Ï†ÏÎ½: <span id="count">0</span> â€¢ Î£ÏÎ½Î¿Î»Î¿ â‚¬: <span id="sum">0.00</span></span>
    </div>
  </section>
</main>

<script>
  // ---------------- Helpers
  function $(s){return document.querySelector(s);}
  function $all(s){return Array.prototype.slice.call(document.querySelectorAll(s));}
  function num(v){var n=parseFloat(v);return isNaN(n)?0:n;}
  function money(v){return num(v).toFixed(2);}
  function setStatus(m){$('#status').textContent=m;}

  var fields = {
    date:$('#date'), startTime:$('#startTime'), endTime:$('#endTime'), hours:$('#hours'),
    client:$('#client'), location:$('#location'), task:$('#task'),
    labor:$('#labor'), vatRate:$('#vatRate'), subtotal:$('#subtotal'),
    vatAmount:$('#vatAmount'), grandTotal:$('#grandTotal'), invoice:$('#invoice')
  };
  var tbody=$('#table tbody'),
      matBody=$('#materialsTable tbody'), materialsSumEl=$('#materialsSum'),
      countEl=$('#count'), sumEl=$('#sum');

  // ---------------- Local Storage keys
  var STORAGE_KEY='jobs_v1';
  var LS_CLIENTS='saved_clients';
  var LS_LOCATIONS='saved_locations';

  var data = loadJobs();
  var saved = {clients:[], locations:[]};
  loadSavedLists();

  // ---------------- Init values
  fields.date.valueAsDate = new Date();
  fields.vatRate.value = localStorage.getItem('vat_default') || 24;

  function loadJobs(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch(e){return [];} }
  function saveJobs(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

  function loadSavedLists(){
    try{ saved.clients=JSON.parse(localStorage.getItem(LS_CLIENTS)||'[]'); }catch(e){ saved.clients=[]; }
    try{ saved.locations=JSON.parse(localStorage.getItem(LS_LOCATIONS)||'[]'); }catch(e){ saved.locations=[]; }
    updateDatalists();
  }
  function saveSavedLists(){
    localStorage.setItem(LS_CLIENTS, JSON.stringify(saved.clients));
    localStorage.setItem(LS_LOCATIONS, JSON.stringify(saved.locations));
  }
  function uniquePush(arr, value){
    var v=String(value||'').trim(); if(!v) return;
    for(var i=0;i<arr.length;i++){ if(arr[i].toLowerCase()===v.toLowerCase()) return; }
    arr.push(v);
  }
  function updateDatalists(){
    var cl = $('#clientsList'), ll = $('#locationsList'); if(!cl||!ll) return;
    cl.innerHTML=''; ll.innerHTML='';
    for(var i=0;i<saved.clients.length;i++){ var o=document.createElement('option'); o.value=saved.clients[i]; cl.appendChild(o); }
    for(var j=0;j<saved.locations.length;j++){ var p=document.createElement('option'); p.value=saved.locations[j]; ll.appendChild(p); }
  }
  function rememberCurrentValues(){
    uniquePush(saved.clients, fields.client.value);
    uniquePush(saved.locations, fields.location.value);
    saveSavedLists(); updateDatalists();
  }
  function rememberClient(){ uniquePush(saved.clients, fields.client.value); saveSavedLists(); updateDatalists(); alert('ÎŸ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ âœ“'); }
  function rememberLocation(){ uniquePush(saved.locations, fields.location.value); saveSavedLists(); updateDatalists(); alert('Î— Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ âœ“'); }
  function manageList(kind){
    var arr = (kind==='clients') ? saved.clients.slice() : saved.locations.slice();
    var title = (kind==='clients') ? 'Î ÎµÎ»Î¬Ï„ÎµÏ‚' : 'Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯ÎµÏ‚';
    var txt = 'Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± '+title+' (Î¼Î¯Î± Î±Î½Î¬ Î³ÏÎ±Î¼Î¼Î®):\\n\\n' + arr.join('\\n');
    var res = prompt(txt, arr.join('\\n'));
    if(res===null) return;
    var lines = res.split(/\\r?\\n/); var out=[];
    for(var i=0;i<lines.length;i++){ var s=(lines[i]||'').trim(); if(s) out.push(s); }
    if(kind==='clients') saved.clients = out; else saved.locations = out;
    saveSavedLists(); updateDatalists(); alert('Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ âœ“');
  }

  document.getElementById('saveClient').addEventListener('click', rememberClient);
  document.getElementById('saveLocation').addEventListener('click', rememberLocation);
  document.getElementById('manageClients').addEventListener('click', function(){ manageList('clients'); });
  document.getElementById('manageLocations').addEventListener('click', function(){ manageList('locations'); });

  // ---------------- Times â†’ Hours
  function timeToMin(t){if(!t)return null; var p=t.split(':'),h=parseInt(p[0],10),m=parseInt(p[1],10); return h*60+m;}
  function minToHours(m){return (m/60).toFixed(2);}
  function calcHours(){var s=timeToMin(fields.startTime.value), e=timeToMin(fields.endTime.value); if(s==null||e==null)return; var d=e-s; if(d<0)d+=24*60; fields.hours.value=minToHours(d);}

  document.getElementById('startTime').addEventListener('input',function(){calcHours(); recalcTotals();});
  document.getElementById('endTime').addEventListener('input',function(){calcHours(); recalcTotals();});

  // ---------------- Materials
  function bindMatRow(tr){
    var inputs = tr.querySelectorAll('input');
    for(var i=0;i<inputs.length;i++){ inputs[i].addEventListener('input', recalcMaterials); }
    tr.querySelector('.del-row').addEventListener('click', function(){ tr.parentNode.removeChild(tr); recalcMaterials(); renumberRows(); });
  }
  function renumberRows(){
    var rows = matBody.querySelectorAll('tr');
    for(var i=0;i<rows.length;i++){ rows[i].firstChild.textContent = (i+1); }
  }
  function addMaterialRow(row){
    var tr=document.createElement('tr');
    var qty = row && row.qty!=null ? row.qty : 1;
    var unit= row && row.unit ? row.unit : '';
    var price=row && row.price!=null ? row.price : 0;
    tr.innerHTML =
      '<td class="nowrap">'+(matBody.children.length+1)+'</td>'+
      '<td><input class="mat-desc" placeholder="Ï€.Ï‡. ÎšÎ±Î»ÏÎ´Î¹Î¿ 3x2.5"></td>'+
      '<td style="width:100px"><input type="number" min="0" step="0.01" class="mat-qty" value="'+qty+'"></td>'+
      '<td style="width:110px"><input class="mat-unit" placeholder="Ï€.Ï‡. m, Ï„Î¼Ï‡" value="'+unit+'"></td>'+
      '<td style="width:130px"><input type="number" min="0" step="0.01" class="mat-price" value="'+price+'"></td>'+
      '<td class="right line-total">0.00</td>'+
      '<td><button class="del-row">ğŸ—‘ï¸</button></td>';
    matBody.appendChild(tr);
    if(row && row.desc){ tr.querySelector('.mat-desc').value=row.desc; }
    bindMatRow(tr);
    recalcMaterials();
  }
  function getMaterials(){
    var rows = matBody.querySelectorAll('tr'); var arr=[];
    for(var i=0;i<rows.length;i++){
      var tr=rows[i];
      var desc=tr.querySelector('.mat-desc').value.trim();
      var qty=num(tr.querySelector('.mat-qty').value);
      var unit=tr.querySelector('.mat-unit').value.trim();
      var price=num(tr.querySelector('.mat-price').value);
      if(desc || qty || price){ arr.push({desc:desc, qty:qty, unit:unit, price:price}); }
    }
    return arr;
  }
  function recalcMaterials(){
    var rows = matBody.querySelectorAll('tr'); var sum=0;
    for(var i=0;i<rows.length;i++){
      var tr=rows[i];
      var qty=num(tr.querySelector('.mat-qty').value);
      var price=num(tr.querySelector('.mat-price').value);
      var line=qty*price;
      tr.querySelector('.line-total').textContent=money(line);
      sum+=line;
    }
    materialsSumEl.textContent=money(sum);
    recalcTotals();
  }

  // ---------------- Totals & VAT
  function recalcTotals(){
    var labor=num(fields.labor.value);
    var mats=num(materialsSumEl.textContent);
    var subtotal=labor+mats;
    var vatRate=Math.max(0, num(fields.vatRate.value));
    var vatAmount=subtotal*vatRate/100;
    fields.subtotal.value=money(subtotal);
    fields.vatAmount.value=money(vatAmount);
    fields.grandTotal.value=money(subtotal+vatAmount);
    localStorage.setItem('vat_default', String(vatRate));
  }
  document.getElementById('labor').addEventListener('input', function(){recalcMaterials();});
  document.getElementById('vatRate').addEventListener('input', function(){recalcMaterials();});

  // ---------------- CRUD
  var editingIndex = null;

  function clearForm(){
    fields.startTime.value=''; fields.endTime.value=''; fields.hours.value='';
    fields.client.value=''; fields.location.value=''; fields.task.value='';
    fields.labor.value=''; fields.subtotal.value=''; fields.vatAmount.value='';
    fields.grandTotal.value=''; fields.invoice.value='';
    matBody.innerHTML=''; addMaterialRow(); setStatus('ÎˆÏ„Î¿Î¹Î¼Î¿');
    document.getElementById('addBtn').style.display=''; document.getElementById('updateBtn').style.display='none';
    editingIndex=null;
  }
  function collect(){
    var mats=getMaterials();
    var matsSum=0; for(var i=0;i<mats.length;i++){ matsSum+=mats[i].qty*mats[i].price; }
    var subtotal=num(fields.labor.value)+matsSum;
    var vatRate=Math.max(0, num(fields.vatRate.value));
    var vatAmount=subtotal*vatRate/100;
    return {
      id: Date.now().toString()+Math.random(),
      date: fields.date.value || new Date().toISOString().slice(0,10),
      startTime: fields.startTime.value || '',
      endTime: fields.endTime.value || '',
      hours: money(fields.hours.value),
      client: fields.client.value.trim(),
      location: fields.location.value.trim(),
      task: fields.task.value.trim(),
      materials: mats,
      materialsSum: money(matsSum),
      labor: money(fields.labor.value),
      subtotal: money(subtotal),
      vatRate: vatRate,
      vatAmount: money(vatAmount),
      total: money(subtotal+vatAmount),
      invoice: fields.invoice.value.trim()
    };
  }
  function validate(r){ if(!r.client) return 'Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î¿Î½ Ï€ÎµÎ»Î¬Ï„Î·'; if(!r.task) return 'Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î¹Ï‚ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚'; return null; }

  function add(){
    var r=collect(); var err=validate(r); if(err){alert(err);return;}
    // Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï€ÎµÎ»Î¬Ï„Î·/Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±Ï‚ Î³Î¹Î± ÎµÏ€ÏŒÎ¼ÎµÎ½ÎµÏ‚ Ï€ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚
    rememberCurrentValues();
    data.push(r); saveJobs(); render(); clearForm(); setStatus('Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ âœ…');
  }
  function startEdit(id){
    var idx=-1; for(var i=0;i<data.length;i++){ if(data[i].id===id){idx=i;break;} }
    if(idx===-1) return;
    var r=data[idx]; editingIndex=idx;
    fields.date.value=r.date; fields.startTime.value=r.startTime||''; fields.endTime.value=r.endTime||'';
    fields.hours.value=r.hours; fields.client.value=r.client; fields.location.value=r.location;
    fields.task.value=r.task; fields.labor.value=r.labor; fields.vatRate.value=r.vatRate;
    fields.subtotal.value=r.subtotal; fields.vatAmount.value=r.vatAmount; fields.grandTotal.value=r.total; fields.invoice.value=r.invoice||'';
    matBody.innerHTML=''; for(var j=0;j<(r.materials||[]).length;j++){ addMaterialRow(r.materials[j]); } if((r.materials||[]).length===0){addMaterialRow();}
    document.getElementById('addBtn').style.display='none'; document.getElementById('updateBtn').style.display='';
    setStatus('Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±â€¦'); window.scrollTo(0,0);
  }
  function update(){
    if(editingIndex==null) return;
    var r=collect(); r.id=data[editingIndex].id;
    var err=validate(r); if(err){alert(err);return;}
    data[editingIndex]=r; saveJobs(); render(); clearForm(); setStatus('Î•Î½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ ğŸ’¾');
  }
  function removeItem(id){
    if(!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚;')) return;
    var arr=[]; for(var i=0;i<data.length;i++){ if(data[i].id!==id) arr.push(data[i]); }
    data=arr; saveJobs(); render(); setStatus('Î”Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ ğŸ—‘ï¸');
  }

  // ---------------- List & toolbar
  function addRow(r){
    var tr=document.createElement('tr');
    var cells=[r.date,r.startTime||'â€”',r.endTime||'â€”',r.hours,r.client,r.location,r.task,
               money(r.labor),money(r.materialsSum),money(r.subtotal),r.vatRate+'%',money(r.vatAmount),money(r.total),r.invoice||'â€”'];
    for(var i=0;i<cells.length;i++){ var td=document.createElement('td'); td.textContent=cells[i]; tr.appendChild(td); }
    var tdAct=document.createElement('td');
    var e=document.createElement('button'); e.textContent='âœï¸'; e.addEventListener('click',function(){startEdit(r.id);});
    var d=document.createElement('button'); d.textContent='ğŸ—‘ï¸'; d.addEventListener('click',function(){removeItem(r.id);});
    tdAct.appendChild(e); tdAct.appendChild(document.createTextNode(' ')); tdAct.appendChild(d);
    tr.appendChild(tdAct);
    tbody.appendChild(tr);
  }
  function render(){
    tbody.innerHTML='';
    var s=0;
    for(var i=0;i<data.length;i++){ addRow(data[i]); s+=num(data[i].total); }
    countEl.textContent=data.length; sumEl.textContent=s.toFixed(2);
  }

  function downloadFile(filename, mime, content) {
    var blob = new Blob([content], {type: mime});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    setTimeout(function(){ URL.revokeObjectURL(url); }, 0);
  }
  function csvEscape(s) {
    s = String(s == null ? '' : s);
    return '"' + s.replace(/"/g, '""') + '"';
  }
  function exportCsv() {
    var rows = [['Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±','ÎÏÎ± ÎˆÎ½Î±ÏÎ¾Î·Ï‚','ÎÏÎ± Î›Î®Î¾Î·Ï‚','ÎÏÎµÏ‚','Î ÎµÎ»Î¬Ï„Î·Ï‚','Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±','Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚','Î•ÏÎ³Î±ÏƒÎ¯Î± (â‚¬)','Î¥Î»Î¹ÎºÎ¬ (â‚¬)','Î¥Ï€Î¿ÏƒÏÎ½Î¿Î»Î¿ (â‚¬)','Î¦Î Î‘ (%)','Î¦Î Î‘ (â‚¬)','Î£ÏÎ½Î¿Î»Î¿ (â‚¬)','Î Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÏŒ','Î¥Î»Î¹ÎºÎ¬ (Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬)']];
    for (var i=0;i<data.length;i++) {
      var r = data[i];
      var mats = (r.materials||[]).map(function(m){
        return m.desc + ' x' + m.qty + ' ' + m.unit + ' @' + money(m.price) + 'â‚¬ = ' + money(m.qty*m.price) + 'â‚¬';
      }).join(' | ');
      rows.push([r.date,r.startTime||'',r.endTime||'',r.hours,r.client,r.location,r.task,r.labor,r.materialsSum,r.subtotal,r.vatRate,r.vatAmount,r.total,r.invoice||'',mats]);
    }
    var csv = rows.map(function(row){ return row.map(csvEscape).join(','); }).join('\n');
    downloadFile('Î´Î¿Ï…Î»ÎµÎ¹Î­Ï‚.csv','text/csv;charset=utf-8;', csv);
    setStatus('Î•Î¾Î±Î³Ï‰Î³Î® CSV âœ“');
  }
  function backupJson() {
    downloadFile('jobs-backup.json','application/json', JSON.stringify(data, null, 2));
    setStatus('Î‘Î½Ï„Î¯Î³ÏÎ±Ï†Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ âœ“');
  }
  function restoreJson(ev) {
    var f = ev.target.files && ev.target.files[0]; if (!f) return;
    var reader = new FileReader();
    reader.onload = function(){
      try {
        var arr = JSON.parse(reader.result);
        if (!Array.isArray(arr)) throw new Error('bad');
        data = arr; saveJobs(); render(); setStatus('Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ OK âœ“');
      } catch(e){ alert('ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ JSON'); }
    };
    reader.readAsText(f);
    ev.target.value = '';
  }
  function printList() {
    var w = window.open('', '_blank');
    var style = 'body{font-family:system-ui,Segoe UI,Arial;padding:24px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ddd;padding:6px 8px;font-size:12px} th{background:#f3f4f6}';
    w.document.write('<html><head><title>Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</title><style>'+style+'</style></head><body>');
    w.document.write('<h2>Î›Î¯ÏƒÏ„Î± Î”Î¿Ï…Î»ÎµÎ¹ÏÎ½</h2>');
    w.document.write('<table><thead><tr><th>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th><th>ÎˆÎ½Î±ÏÎ¾Î·</th><th>Î›Î®Î¾Î·</th><th>ÎÏÎµÏ‚</th><th>Î ÎµÎ»Î¬Ï„Î·Ï‚</th><th>Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±</th><th>Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚</th><th>Î•ÏÎ³Î±ÏƒÎ¯Î± (â‚¬)</th><th>Î¥Î»Î¹ÎºÎ¬ (â‚¬)</th><th>Î¥Ï€Î¿ÏƒÏÎ½Î¿Î»Î¿</th><th>Î¦Î Î‘</th><th>Î£ÏÎ½Î¿Î»Î¿</th><th>Î Î±ÏÎ±ÏƒÏ„.</th></tr></thead><tbody>');
    for (var i=0;i<data.length;i++){
      var r=data[i];
      w.document.write('<tr><td>'+r.date+'</td><td>'+(r.startTime||'')+'</td><td>'+(r.endTime||'')+'</td><td>'+r.hours+'</td><td>'+r.client+'</td><td>'+r.location+'</td><td>'+r.task+'</td><td>'+r.labor+'</td><td>'+r.materialsSum+'</td><td>'+r.subtotal+'</td><td>'+r.vatRate+'% ('+r.vatAmount+'â‚¬)</td><td>'+r.total+'</td><td>'+(r.invoice||'')+'</td></tr>');
    }
    var s=0; for (var j=0;j<data.length;j++){ s += num(data[j].total); }
    w.document.write('<tfoot><tr><td colspan="11" style="text-align:right"><b>Î£ÏÎ½Î¿Î»Î¿ (â‚¬):</b></td><td colspan="2"><b>'+s.toFixed(2)+'</b></td></tr></tfoot>');
    w.document.write('</tbody></table></body></html>');
    w.document.close(); w.focus(); w.print();
  }

  // ---------------- Wire up
  document.getElementById('addMat').addEventListener('click', function(){ addMaterialRow(); });
  document.getElementById('clearMat').addEventListener('click', function(){
    if(confirm('ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Ï…Î»Î¹ÎºÏÎ½;')){ matBody.innerHTML=''; addMaterialRow(); recalcMaterials(); }
  });
  document.getElementById('addBtn').addEventListener('click', add);
  document.getElementById('updateBtn').addEventListener('click', update);
  document.getElementById('clearFormBtn').addEventListener('click', function(){ clearForm(); });

  document.getElementById('exportCsv').addEventListener('click', exportCsv);
  document.getElementById('printList').addEventListener('click', printList);
  document.getElementById('backupJson').addEventListener('click', backupJson);
  document.getElementById('restoreJson').addEventListener('change', restoreJson);

  // ---------------- Start
  addMaterialRow();     // Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 1 Î³ÏÎ±Î¼Î¼Î® Ï…Î»Î¹ÎºÎ¿Ï
  render();
</script>
</body>
</html>
