<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Καταγραφή Δουλειών + Υλικά & ΦΠΑ (PWA)</title>
  <style>
    :root {
      --bg: #0f172a; --panel: #111827; --panel-2: #0b1220; --text: #e5e7eb; --muted: #9ca3af; --accent: #22d3ee; --accent-2: #a78bfa; --ok: #34d399; --warn: #fbbf24; --err: #f87171; --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: linear-gradient(120deg, var(--bg), #0b1022 60%, #0a0f1c); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Ubuntu, Cantarell, "Helvetica Neue", Arial; color: var(--text); }
    header { position: sticky; top: 0; backdrop-filter: blur(6px); background: rgba(15,23,42,.6); border-bottom: 1px solid var(--border); z-index: 5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { font-size: clamp(20px,3vw,28px); margin: 8px 0 4px; }
    .sub { color: var(--muted); font-size: 13px; margin-bottom: 8px; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .card { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid var(--border); border-radius: 14px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    label { display: block; font-size: 12px; color: var(--muted); margin: 6px 0 6px 2px; }
    input, textarea, select { width: 100%; background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; font-size: 14px; outline: none; transition: border-color .15s, box-shadow .15s; }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(34,211,238,.15); }
    textarea { min-height: 70px; resize: vertical; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .btns { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    button { cursor: pointer; border: 1px solid var(--border); background: #0b1220; color: var(--text); padding: 10px 14px; border-radius: 999px; font-weight: 600; font-size: 14px; transition: transform .05s, background .15s; box-shadow: 0 4px 14px rgba(0,0,0,.25); }
    button:hover { background: #0f172a; } button:active { transform: translateY(1px); }
    .primary { background: linear-gradient(90deg, var(--accent), var(--accent-2)); border: none; color: #041016; }
    .ok { background: linear-gradient(90deg, var(--ok), #60a5fa); border: none; color: #05140a; }
    .warn { background: linear-gradient(90deg, var(--warn), #fb7185); border: none; color: #140b05; }
    .ghost { background: transparent; border: 1px dashed var(--border); }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px 10px; font-size: 14px; text-align: left; vertical-align: top; }
    th { color: var(--muted); font-weight: 600; position: sticky; top: 0; background: #0c1322; z-index: 3; }
    tbody tr:hover { background: rgba(255,255,255,.02); }
    .pill { font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); }
    .sum { font-weight: 700; }
    .footer { color: var(--muted); font-size: 12px; text-align: center; padding: 20px 0 40px; }
    .right { text-align: right; }
    .nowrap { white-space: nowrap; }
    @media (max-width: 900px){ .grid, .row { grid-template-columns: repeat(6,1fr);} }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>📒 Καταγραφή Δουλειών — Υλικά & ΦΠΑ (Offline PWA)</h1>
      <div class="sub">Καταχώριση εργασιών με αναλυτικά υλικά, αυτόματο ΦΠΑ (24% Ελλάδα — παραμετροποιήσιμο), εξαγωγή CSV, εκτύπωση, αντίγραφα, και εγκατάσταση ως εφαρμογή.</div>
    </div>
  </header>

  <main class="container" id="app">
    <!-- Φόρμα εγγραφής -->
    <section class="card">
      <div class="row">
        <div style="grid-column: span 3;">
          <label>Ημερομηνία</label>
          <input type="date" id="date" />
        </div>
        <div style="grid-column: span 3;">
          <label>Ώρες Εργασίας</label>
          <input type="number" id="hours" step="0.1" min="0" placeholder="π.χ. 2.5" />
        </div>
        <div style="grid-column: span 6;">
          <label>Πελάτης</label>
          <input type="text" id="client" placeholder="Όνομα πελάτη" />
        </div>
        <div style="grid-column: span 6;">
          <label>Τοποθεσία</label>
          <input type="text" id="location" placeholder="Διεύθυνση ή περιοχή" />
        </div>
        <div style="grid-column: span 6;">
          <label>Εργασίες (περιγραφή)</label>
          <textarea id="task" placeholder="Σύντομη περιγραφή εργασιών..."></textarea>
        </div>

        <!-- Υλικά: αναλυτικές γραμμές -->
        <div style="grid-column: span 12;">
          <label>Υλικά (αναλυτικά)</label>
          <div style="overflow:auto; border:1px solid var(--border); border-radius:12px;">
            <table id="materialsTable">
              <thead>
                <tr>
                  <th style="width:32px">#</th>
                  <th>Περιγραφή</th>
                  <th class="nowrap">Ποσότητα</th>
                  <th class="nowrap">Μονάδα</th>
                  <th class="nowrap right">Τιμή Μον. (€)</th>
                  <th class="nowrap right">Γραμμή (€)</th>
                  <th>Ενέργεια</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td colspan="5" class="right sum">Σύνολο Υλικών (€)</td>
                  <td class="right"><span id="materialsSum">0.00</span></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="btns" style="margin-top:8px;">
            <button id="addMat" class="ghost">➕ Γραμμή υλικού</button>
            <button id="clearMat" class="ghost">🧹 Καθαρισμός υλικών</button>
          </div>
        </div>

        <!-- Κόστη & ΦΠΑ -->
        <div style="grid-column: span 3;">
          <label>Κόστος Εργασίας (€)</label>
          <input type="number" id="labor" step="0.01" min="0" placeholder="0.00" />
        </div>
        <div style="grid-column: span 3;">
          <label>Συντελεστής ΦΠΑ (%)</label>
          <input type="number" id="vatRate" step="0.5" min="0" placeholder="24" />
        </div>
        <div style="grid-column: span 3;">
          <label>Υποσύνολο (€) (Εργασία+Υλικά)</label>
          <input type="number" id="subtotal" step="0.01" readonly />
        </div>
        <div style="grid-column: span 3;">
          <label>ΦΠΑ (€)</label>
          <input type="number" id="vatAmount" step="0.01" readonly />
        </div>
        <div style="grid-column: span 3;">
          <label>Σύνολο (€) με ΦΠΑ</label>
          <input type="number" id="grandTotal" step="0.01" readonly />
        </div>
        <div style="grid-column: span 3;">
          <label>Αρ. Παραστατικού (προαιρετικό)</label>
          <input type="text" id="invoice" placeholder="π.χ. ΤΠΥ-123" />
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="addBtn">➕ Προσθήκη</button>
        <button id="updateBtn" style="display:none">💾 Ενημέρωση</button>
        <button class="ghost" id="clearFormBtn">🧹 Εκκαθάριση φόρμας</button>
        <button id="installBtn" class="ok" style="display:none">📲 Εγκατάσταση</button>
        <span class="pill" id="status">Έτοιμο</span>
      </div>
    </section>

    <!-- Λίστα εγγραφών, φίλτρα, εξαγωγές -->
    <section class="card" style="margin-top: 12px;">
      <div class="row">
        <div style="grid-column: span 3;">
          <label>Από</label>
          <input type="date" id="filterFrom" />
        </div>
        <div style="grid-column: span 3;">
          <label>Έως</label>
          <input type="date" id="filterTo" />
        </div>
        <div style="grid-column: span 3;">
          <label>Πελάτης (φίλτρο)</label>
          <input type="text" id="filterClient" placeholder="π.χ. Γιάννης" />
        </div>
        <div style="grid-column: span 3;">
          <label>Κείμενο (τοποθεσία/εργασίες)</label>
          <input type="text" id="filterText" placeholder="λέξη-κλειδί" />
        </div>
      </div>
      <div class="btns">
        <button id="applyFilters">🔎 Εφαρμογή φίλτρων</button>
        <button id="resetFilters" class="ghost">♻️ Καθαρισμός φίλτρων</button>
        <button id="exportCsv" class="ok">⬇️ Εξαγωγή CSV</button>
        <button id="printList" class="warn">🖨️ Εκτύπωση</button>
        <button id="backupJson" class="ghost">💾 Αντίγραφο (JSON)</button>
        <label class="pill" style="cursor:pointer">📤 Εισαγωγή JSON
          <input id="restoreJson" type="file" accept="application/json" style="display:none" />
        </label>
        <span class="pill">Σύνολο εγγραφών: <span id="count">0</span> • Σύνολο €: <span id="sum">0.00</span></span>
      </div>

      <div style="overflow:auto; max-height: 50vh; margin-top: 8px; border:1px solid var(--border); border-radius: 12px;">
        <table id="table">
          <thead>
            <tr>
              <th>Ημερομηνία</th>
              <th>Ώρες</th>
              <th>Πελάτης</th>
              <th>Τοποθεσία</th>
              <th>Εργασίες</th>
              <th>Εργασία (€)</th>
              <th>Υλικά (€)</th>
              <th>Υποσύνολο (€)</th>
              <th>ΦΠΑ (%)</th>
              <th>ΦΠΑ (€)</th>
              <th>Σύνολο (€)</th>
              <th>Παραστ.</th>
              <th>Ενέργειες</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div class="footer">Δεδομένα αποθηκεύονται τοπικά (localStorage). Υποστηρίζεται offline λειτουργία μέσω service worker. Για πλήρες PWA/εικονίδιο, αποθήκευσε το αρχείο αυτό και άνοιξέ το από έναν μικρό τοπικό server (π.χ. <code>npx serve</code>).</div>
    <section class="container card" style="margin-top:12px;">
    <h3 style="margin:0 0 8px 0;">⚙️ PWA Οδηγός & Αρχεία</h3>
    <p class="sub">Κατέβασε τα αρχεία <strong>manifest</strong> & <strong>εικονίδια</strong> και βάλε τα στον ίδιο φάκελο με το αρχείο αυτό (<code>index.html</code>). Έπειτα άνοιξέ το μέσω https ή <code>localhost</code>.</p>
    <div class="btns">
      <button id="dlManifest" class="ok">📄 Κατέβασε <code>manifest.webmanifest</code></button>
      <button id="dlIcon192" class="ghost">🖼️ Κατέβασε <code>icon-192.png</code></button>
      <button id="dlIcon512" class="ghost">🖼️ Κατέβασε <code>icon-512.png</code></button>
      <button id="pwaGuide" class="warn">📘 3 Βήματα Hosting</button>
    </div>
    <ol style="margin-top:8px;">
      <li><strong>Αποθήκευση αρχείων:</strong> Κατέβασε τα τρία αρχεία και βάλε τα δίπλα στο <code>index.html</code>.</li>
      <li><strong>Τοπικός server:</strong> Άνοιξε τερματικό στον φάκελο και τρέξε <code>npx serve</code> ή <code>python -m http.server 5173</code> και μπες στο <code>http://localhost:5173</code> (ή την πόρτα που θα δείξει).</li>
      <li><strong>Online (HTTPS):</strong> Ανέβασε τα 4 αρχεία (index.html, manifest.webmanifest, icon-192.png, icon-512.png) σε Netlify/Vercel/GitHub Pages/Cloudflare Pages. Μετά άνοιξέ το site και πάτα «Εγκατάσταση».</li>
    </ol>
  </section>

  </main>

  <script>
    const $$ = sel => document.querySelector(sel);
    const $$$ = sel => Array.from(document.querySelectorAll(sel));

    const fields = { date: $$('#date'), hours: $$('#hours'), client: $$('#client'), location: $$('#location'), task: $$('#task'), labor: $$('#labor'), vatRate: $$('#vatRate'), subtotal: $$('#subtotal'), vatAmount: $$('#vatAmount'), grandTotal: $$('#grandTotal'), invoice: $$('#invoice') };

    const statusEl = $$('#status');
    const tbody = document.querySelector('#table tbody');
    const materialsTBody = document.querySelector('#materialsTable tbody');
    const materialsSumEl = $$('#materialsSum');
    const countEl = $$('#count');
    const sumEl = $$('#sum');
    const STORAGE_KEY = 'jobs_v2';

    let data = load();
    let editingIndex = null;

    // Defaults
    fields.date.valueAsDate = new Date();
    fields.vatRate.value = localStorage.getItem('vat_default') || 24;

    function load(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; } }
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

    function toNumber(v){ const n = parseFloat(v); return isNaN(n) ? 0 : n; }
    function money(v){ return (toNumber(v)).toFixed(2); }

    // ===== ΥΛΙΚΑ =====
    function addMaterialRow(row){
      const tr = document.createElement('tr');
      const idx = materialsTBody.children.length + 1;
      tr.innerHTML = `
        <td class="nowrap">${idx}</td>
        <td><input placeholder="π.χ. Καλώδιο 3x2.5" class="mat-desc"/></td>
        <td style="width:110px"><input type="number" min="0" step="0.01" class="mat-qty" value="1"/></td>
        <td style="width:120px"><input placeholder="π.χ. m, τμχ" class="mat-unit"/></td>
        <td style="width:140px"><input type="number" min="0" step="0.01" class="mat-price right" value="0"/></td>
        <td class="right line-total">0.00</td>
        <td><button class="ghost del-row">🗑️</button></td>`;
      materialsTBody.appendChild(tr);
      if(row){ tr.querySelector('.mat-desc').value = row.desc || ''; tr.querySelector('.mat-qty').value = row.qty || 1; tr.querySelector('.mat-unit').value = row.unit || ''; tr.querySelector('.mat-price').value = row.price || 0; }
      bindMatRow(tr);
      recalcMaterials();
    }

    function bindMatRow(tr){
      tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', recalcMaterials));
      tr.querySelector('.del-row').addEventListener('click', ()=> { tr.remove(); recalcMaterials(); });
    }

    function getMaterials(){
      return $$$('#materialsTable tbody tr').map(tr => ({
        desc: tr.querySelector('.mat-desc').value.trim(),
        qty: toNumber(tr.querySelector('.mat-qty').value),
        unit: tr.querySelector('.mat-unit').value.trim(),
        price: toNumber(tr.querySelector('.mat-price').value),
      })).filter(r => r.desc || r.qty || r.price);
    }

    function recalcMaterials(){
      let sum = 0;
      $$$('#materialsTable tbody tr').forEach(tr => {
        const qty = toNumber(tr.querySelector('.mat-qty').value);
        const price = toNumber(tr.querySelector('.mat-price').value);
        const line = qty * price;
        tr.querySelector('.line-total').textContent = money(line);
        sum += line;
      });
      materialsSumEl.textContent = money(sum);
      recalcTotals();
    }

    // ===== ΣΥΝΟΛΑ & ΦΠΑ =====
    function recalcTotals(){
      const labor = toNumber(fields.labor.value);
      const mats = toNumber(materialsSumEl.textContent);
      const subtotal = labor + mats;
      const vatRate = Math.max(0, toNumber(fields.vatRate.value));
      const vatAmount = subtotal * vatRate / 100;
      const grand = subtotal + vatAmount;
      fields.subtotal.value = money(subtotal);
      fields.vatAmount.value = money(vatAmount);
      fields.grandTotal.value = money(grand);
      localStorage.setItem('vat_default', String(vatRate));
    }

    ['labor','vatRate'].forEach(id => $(`#${id}`).addEventListener('input', ()=>{ recalcMaterials(); recalcTotals(); }));

    // ===== CRUD =====
    function status(msg){ statusEl.textContent = msg; statusEl.style.borderColor = 'var(--border)'; }

    function clearForm(){
      fields.hours.value = '';
      fields.client.value = '';
      fields.location.value = '';
      fields.task.value = '';
      fields.labor.value = '';
      fields.subtotal.value = '';
      fields.vatAmount.value = '';
      fields.grandTotal.value = '';
      fields.invoice.value = '';
      materialsTBody.innerHTML = '';
      addMaterialRow();
      editingIndex = null;
      $$('#addBtn').style.display = '';
      $$('#updateBtn').style.display = 'none';
      status('Έτοιμο');
    }

    function collect(){
      const mats = getMaterials();
      const materialsSum = mats.reduce((s,r)=> s + r.qty*r.price, 0);
      const subtotal = toNumber(fields.labor.value) + materialsSum;
      const vatRate = Math.max(0, toNumber(fields.vatRate.value));
      const vatAmount = subtotal * vatRate / 100;
      return {
        id: crypto.randomUUID(),
        date: fields.date.value || new Date().toISOString().slice(0,10),
        hours: money(fields.hours.value),
        client: fields.client.value.trim(),
        location: fields.location.value.trim(),
        task: fields.task.value.trim(),
        materials: mats,
        materialsSum: money(materialsSum),
        labor: money(fields.labor.value),
        subtotal: money(subtotal),
        vatRate: vatRate,
        vatAmount: money(vatAmount),
        total: money(subtotal + vatAmount),
        invoice: fields.invoice.value.trim()
      };
    }

    function validate(rec){ if(!rec.client) return 'Συμπληρώστε τον πελάτη'; if(!rec.task) return 'Συμπληρώστε τις εργασίες'; return null; }

    function add(){
      const rec = collect();
      const err = validate(rec); if(err){ alert(err); return; }
      data.push(rec); save(); status('Προστέθηκε ✅'); render(); clearForm();
    }

    function startEdit(id){
      const idx = data.findIndex(r => r.id === id); if(idx===-1) return; const r = data[idx]; editingIndex = idx;
      fields.date.value = r.date; fields.hours.value = r.hours; fields.client.value = r.client; fields.location.value = r.location; fields.task.value = r.task; fields.labor.value = r.labor; fields.vatRate.value = r.vatRate ?? (localStorage.getItem('vat_default')||24); fields.subtotal.value = r.subtotal; fields.vatAmount.value = r.vatAmount; fields.grandTotal.value = r.total; fields.invoice.value = r.invoice || '';
      materialsTBody.innerHTML=''; (r.materials||[]).forEach(addMaterialRow); if((r.materials||[]).length===0) addMaterialRow();
      $$('#addBtn').style.display = 'none'; $$('#updateBtn').style.display = '';
      status('Επεξεργασία εγγραφής…'); window.scrollTo({top:0, behavior:'smooth'});
      recalcMaterials();
    }

    function update(){ if(editingIndex===null) return; const rec = collect(); rec.id = data[editingIndex].id; const err = validate(rec); if(err){ alert(err); return; } data[editingIndex] = rec; save(); status('Ενημερώθηκε 💾'); render(); clearForm(); }

    function remove(id){ if(!confirm('Διαγραφή εγγραφής;')) return; data = data.filter(r => r.id !== id); save(); render(); status('Διαγράφηκε 🗑️'); }

    // ===== ΦΙΛΤΡΑ/ΠΙΝΑΚΑΣ =====
    function filtered(){
      const fFrom = $$('#filterFrom').value; const fTo = $$('#filterTo').value; const fClient = ($$('#filterClient').value||'').trim().toLowerCase(); const fText = ($$('#filterText').value||'').trim().toLowerCase();
      return data.filter(r => {
        if(fFrom && r.date < fFrom) return false; if(fTo && r.date > fTo) return false; if(fClient && !r.client.toLowerCase().includes(fClient)) return false; if(fText && !(r.location+" "+r.task).toLowerCase().includes(fText)) return false; return true;
      }).sort((a,b)=> (a.date===b.date?0:(a.date>b.date?1:-1)));
    }

    function addRow(rec){
      const tr = document.createElement('tr');
      const cells = [rec.date, rec.hours, rec.client, rec.location, rec.task, money(rec.labor), money(rec.materialsSum), money(rec.subtotal), rec.vatRate+'%', money(rec.vatAmount), money(rec.total), rec.invoice || '—'];
      cells.forEach(c => { const td = document.createElement('td'); td.textContent = c; tr.appendChild(td); });
      const tdAct = document.createElement('td'); const e = document.createElement('button'); e.textContent = '✏️'; e.className='ghost'; const d = document.createElement('button'); d.textContent='🗑️'; d.className='ghost'; tdAct.append(e,' ',d); tr.appendChild(tdAct);
      e.addEventListener('click', () => startEdit(rec.id)); d.addEventListener('click', ()=> remove(rec.id)); tbody.appendChild(tr);
    }

    function render(){ tbody.innerHTML=''; const items = filtered(); items.forEach(addRow); countEl.textContent = items.length; const sum = items.reduce((s,r)=> s + toNumber(r.total), 0); sumEl.textContent = sum.toFixed(2); }

    function applyFilters(){ render(); status('Εφαρμόστηκαν φίλτρα'); }
    function resetFilters(){ ['#filterFrom','#filterTo','#filterClient','#filterText'].forEach(s=> $$(s).value=''); render(); status('Καθαρίστηκαν φίλτρα'); }

    // ===== ΕΞΑΓΩΓΕΣ =====
    function downloadFile(filename, mime, content){ const blob = new Blob([content], {type: mime}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); setTimeout(()=> URL.revokeObjectURL(url), 0); }

    function exportCsv(){
      const rows = [[ 'Ημερομηνία','Ώρες','Πελάτης','Τοποθεσία','Εργασίες','Εργασία (€)','Υλικά (€)','Υποσύνολο (€)','ΦΠΑ (%)','ΦΠΑ (€)','Σύνολο (€)','Παραστατικό','Υλικά (αναλυτικά)']];
      filtered().forEach(r=>{
        const mats = (r.materials||[]).map(m=> `${m.desc} x${m.qty} ${m.unit} @${money(m.price)}€ = ${money(m.qty*m.price)}€`).join(' | ');
        rows.push([r.date,r.hours,r.client,r.location,r.task,r.labor,r.materialsSum,r.subtotal,r.vatRate,r.vatAmount,r.total,r.invoice||'', mats]);
      });
      const csv = rows.map(row=> row.map(cell => '"'+String(cell).replaceAll('"','""')+'"').join(',')).join('
');
      downloadFile('δουλειές.csv','text/csv;charset=utf-8;',csv); status('Εξήχθη CSV ⬇️');
    }

    function backupJson(){ downloadFile('jobs-backup.json','application/json', JSON.stringify(data,null,2)); status('Αντίγραφο αποθηκεύτηκε 💾'); }

    function restoreJson(ev){ const file = ev.target.files?.[0]; if(!file) return; const reader = new FileReader(); reader.onload = () => { try { const arr = JSON.parse(reader.result); if(!Array.isArray(arr)) throw new Error('bad'); data = arr; save(); render(); status('Επαναφορά ολοκληρώθηκε ✅'); } catch(e){ alert('Μη έγκυρο αρχείο JSON'); } }; reader.readAsText(file); ev.target.value=''; }

    function printList(){
      const w = window.open('', '_blank'); const rows = filtered(); const style = `body{font-family:system-ui,Segoe UI,Arial; padding:24px;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ddd; padding:6px 8px; font-size:12px;} th{background:#f3f4f6;}`;
      w.document.write('<html><head><title>Εκτύπωση</title><style>'+style+'</style></head><body>');
      w.document.write('<h2>Λίστα Δουλειών</h2>');
      w.document.write('<table><thead><tr><th>Ημερομηνία</th><th>Ώρες</th><th>Πελάτης</th><th>Τοποθεσία</th><th>Εργασίες</th><th>Εργασία (€)</th><th>Υλικά (€)</th><th>Υποσύνολο</th><th>ΦΠΑ</th><th>Σύνολο</th><th>Παραστ.</th></tr></thead><tbody>');
      rows.forEach(r=>{ w.document.write(`<tr><td>${r.date}</td><td>${r.hours}</td><td>${esc(r.client)}</td><td>${esc(r.location)}</td><td>${esc(r.task)}</td><td>${r.labor}</td><td>${r.materialsSum}</td><td>${r.subtotal}</td><td>${r.vatRate}% (${r.vatAmount}€)</td><td>${r.total}</td><td>${esc(r.invoice||'')}</td></tr>`); });
      const sum = rows.reduce((s,r)=> s + (parseFloat(r.total)||0), 0).toFixed(2); w.document.write(`<tfoot><tr><td colspan="9" style="text-align:right"><strong>Σύνολο (€):</strong></td><td colspan="2"><strong>${sum}</strong></td></tr></tfoot>`);
      w.document.write('</tbody></table>'); w.document.write('</body></html>'); w.document.close(); w.focus(); w.print();
    }

    function esc(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // Events
    $$('#addMat').addEventListener('click', ()=> addMaterialRow());
    $$('#clearMat').addEventListener('click', ()=> { if(confirm('Καθαρισμός όλων των υλικών;')){ materialsTBody.innerHTML=''; addMaterialRow(); recalcMaterials(); }});
    $$('#addBtn').addEventListener('click', add);
    $$('#updateBtn').addEventListener('click', update);
    $$('#clearFormBtn').addEventListener('click', clearForm);
    $$('#applyFilters').addEventListener('click', applyFilters);
    $$('#resetFilters').addEventListener('click', resetFilters);
    $$('#exportCsv').addEventListener('click', exportCsv);
    $$('#printList').addEventListener('click', printList);
    $$('#backupJson').addEventListener('click', backupJson);
    $$('#restoreJson').addEventListener('change', restoreJson);

    // Init materials with one line
    addMaterialRow();

    // Initial list
    render();

    // ===== PWA SETUP (πλήρες, με manifest & icons) =====
    // Δημιουργία δυναμικού manifest για δοκιμή/τοπική χρήση
    function buildManifest(){
      const manifest = {
        name: "Καταγραφή Δουλειών",
        short_name: "Δουλειές",
        description: "Καταχώριση εργασιών με υλικά & ΦΠΑ, offline.",
        start_url: ".",
        display: "standalone",
        background_color: "#0f172a",
        theme_color: "#22d3ee",
        icons: [
          { src: "icon-192.png", sizes: "192x192", type: "image/png" },
          { src: "icon-512.png", sizes: "512x512", type: "image/png" }
        ]
      };
      return new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/manifest+json' });
    }

    // Προσθήκη <link rel="manifest"> για άμεση δοκιμή
    try {
      const mfBlobUrl = URL.createObjectURL(buildManifest());
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = mfBlobUrl;
      document.head.appendChild(link);
      const meta = document.createElement('meta'); meta.name = 'theme-color'; meta.content = '#22d3ee'; document.head.appendChild(meta);
    } catch(e) { console.warn('Manifest inject failed', e); }

    // Service Worker (offline cache)
    const swCode = `self.addEventListener('install', e=>{ self.skipWaiting(); e.waitUntil(caches.open('jobs-cache-v2').then(c=> c.addAll(['./'])));}); self.addEventListener('activate', e=> self.clients.claim()); self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).then(resp=>{ const copy = resp.clone(); caches.open('jobs-cache-v2').then(c=> c.put(e.request, copy)); return resp; } ).catch(()=> r))); });`;
    try {
      const blob = new Blob([swCode], {type:'text/javascript'});
      const swUrl = URL.createObjectURL(blob);
      if('serviceWorker' in navigator){ navigator.serviceWorker.register(swUrl); }
    } catch(err){ console.warn('SW register failed', err); }

    // Εικονίδια: σχεδίαση PNG 192/512 μέσω canvas και λήψη αρχείων
    function drawIcon(size){
      const c = document.createElement('canvas'); c.width = c.height = size; const ctx = c.getContext('2d');
      // background circle
      ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,size,size);
      ctx.beginPath(); ctx.arc(size/2, size/2, size*0.46, 0, Math.PI*2); ctx.fillStyle = '#111827'; ctx.fill();
      // cyan ring
      ctx.lineWidth = size*0.06; ctx.strokeStyle = '#22d3ee'; ctx.beginPath(); ctx.arc(size/2, size/2, size*0.38, 0, Math.PI*2); ctx.stroke();
      // bolt
      ctx.fillStyle = '#a78bfa';
      ctx.beginPath();
      const w = size*0.16, h = size*0.34; const x = size/2 - w/2, y = size/2 - h/2;
      ctx.moveTo(x, y); ctx.lineTo(x+w*0.55, y); ctx.lineTo(x+w*0.25, y+h*0.55); ctx.lineTo(x+w, y+h*0.55); ctx.lineTo(x+w*0.45, y+h); ctx.lineTo(x+w*0.7, y+h*0.45); ctx.lineTo(x, y+h*0.45); ctx.closePath();
      ctx.fill();
      // label
      ctx.fillStyle = '#e5e7eb'; ctx.font = `${Math.floor(size*0.14)}px system-ui,Segoe UI,Arial`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('Δ', size/2, size*0.78);
      return c.toDataURL('image/png');
    }

    function downloadDataUrl(name, url){ const a=document.createElement('a'); a.href=url; a.download=name; a.click(); }

    $$('#dlIcon192').addEventListener('click', ()=> downloadDataUrl('icon-192.png', drawIcon(192)));
    $$('#dlIcon512').addEventListener('click', ()=> downloadDataUrl('icon-512.png', drawIcon(512)));

    $$('#dlManifest').addEventListener('click', ()=> {
      const b = buildManifest(); const url = URL.createObjectURL(b); const a = document.createElement('a'); a.href = url; a.download = 'manifest.webmanifest'; a.click(); setTimeout(()=> URL.revokeObjectURL(url), 0);
    });

    $$('#pwaGuide').addEventListener('click', ()=>{
      alert(`3 Βήματα Hosting:

1) Βάλε στον ίδιο φάκελο: index.html, manifest.webmanifest, icon-192.png, icon-512.png.
2) Τρέξε τοπικό server: npx serve  ή  python -m http.server 5173  και άνοιξε το http://localhost:5173
3) Για Internet/HTTPS: Ανέβασε τα αρχεία σε Netlify/Vercel/GitHub Pages/Cloudflare Pages. Μετά άνοιξε το site και χρησιμοποίησε το κουμπί \"📲 Εγκατάσταση\".`);
    });

    // Install prompt button
    let deferredPrompt = null; const installBtn = $$('#installBtn');
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installBtn.style.display=''; });
    installBtn.addEventListener('click', async ()=> { if(!deferredPrompt) return; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if(outcome==='accepted'){ installBtn.textContent='✅ Εγκαταστάθηκε'; } deferredPrompt=null; });
