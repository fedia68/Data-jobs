<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Î”Î¿Ï…Î»ÎµÎ¹ÏÎ½ â€” Î¥Î»Î¹ÎºÎ¬, Î¦Î Î‘ & ÎÏÎµÏ‚ (PWA)</title>
  <meta name="theme-color" content="#22d3ee">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{--bg:#0f172a;--panel:#111827;--panel2:#0b1220;--text:#e5e7eb;--muted:#9ca3af;--accent:#22d3ee;--accent2:#a78bfa;--ok:#34d399;--warn:#fbbf24;--border:#1f2937}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(120deg,var(--bg),#0b1022 60%,#0a0f1c);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:rgba(15,23,42,.6);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:5}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h1{font-size:clamp(20px,3vw,28px);margin:8px 0 4px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:8px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    input,textarea,select{width:100%;background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
    input:focus,textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(34,211,238,.15)}
    textarea{min-height:70px;resize:vertical}
    label{display:block;font-size:12px;color:var(--muted);margin:6px 0 6px 2px}
    .btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    button{cursor:pointer;border:1px solid var(--border);background:#0b1220;color:var(--text);padding:10px 14px;border-radius:999px;font-weight:600;font-size:14px;box-shadow:0 4px 14px rgba(0,0,0,.25)}
    button:hover{background:#0f172a} button:active{transform:translateY(1px)}
    .primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#041016}
    .ok{background:linear-gradient(90deg,var(--ok),#60a5fa);border:none;color:#05140a}
    .warn{background:linear-gradient(90deg,var(--warn),#fb7185);border:none;color:#140b05}
    .ghost{background:transparent;border:1px dashed var(--border)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;font-size:14px;text-align:left;vertical-align:top}
    th{color:var(--muted);position:sticky;top:0;background:#0c1322;z-index:3}
    tbody tr:hover{background:rgba(255,255,255,.02)}
    .pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .right{text-align:right}.nowrap{white-space:nowrap}
    @media(max-width:900px){.row{grid-template-columns:repeat(6,1fr)}}
  </style>
</head>
<body>
<header>
  <div class="container">
    <h1>ğŸ“’ ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Î”Î¿Ï…Î»ÎµÎ¹ÏÎ½ â€” Î¥Î»Î¹ÎºÎ¬, Î¦Î Î‘ & ÎÏÎµÏ‚ (Offline PWA)</h1>
    <div class="sub">ÎÏÎ± Î­Î½Î±ÏÎ¾Î·Ï‚/Î±Ï€Î¿Ï€ÎµÏÎ¬Ï„Ï‰ÏƒÎ·Ï‚ Î¼Îµ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î¿ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒ Ï‰ÏÏÎ½, Ï…Î»Î¹ÎºÎ¬, Î¦Î Î‘, CSV, offline & ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·.</div>
  </div>
</header>

<main class="container" id="app">
  <section class="card">
    <div class="row">
      <div style="grid-column:span 3">
        <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
        <input type="date" id="date">
      </div>
      <div style="grid-column:span 3">
        <label>ÎÏÎ± ÎˆÎ½Î±ÏÎ¾Î·Ï‚</label>
        <input type="time" id="startTime" step="60">
      </div>
      <div style="grid-column:span 3">
        <label>ÎÏÎ± Î‘Ï€Î¿Ï€ÎµÏÎ¬Ï„Ï‰ÏƒÎ·Ï‚</label>
        <input type="time" id="endTime" step="60">
      </div>
      <div style="grid-column:span 3">
        <label>ÎÏÎµÏ‚ Î•ÏÎ³Î±ÏƒÎ¯Î±Ï‚ (Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î­Î½Î¿)</label>
        <input type="number" id="hours" step="0.1" min="0" placeholder="Ï€.Ï‡. 2.5">
      </div>

      <div style="grid-column:span 6">
        <label>Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
        <input type="text" id="client" placeholder="ÎŒÎ½Î¿Î¼Î± Ï€ÎµÎ»Î¬Ï„Î·">
      </div>
      <div style="grid-column:span 6">
        <label>Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±</label>
        <input type="text" id="location" placeholder="Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î® Ï€ÎµÏÎ¹Î¿Ï‡Î®">
      </div>
      <div style="grid-column:span 6">
        <label>Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚ (Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î®)</label>
        <textarea id="task" placeholder="Î£ÏÎ½Ï„Î¿Î¼Î· Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î® ÎµÏÎ³Î±ÏƒÎ¹ÏÎ½..."></textarea>
      </div>

      <!-- Î¥Î»Î¹ÎºÎ¬ -->
      <div style="grid-column:span 12">
        <label>Î¥Î»Î¹ÎºÎ¬ (Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬)</label>
        <div style="overflow:auto;border:1px solid var(--border);border-radius:12px;">
          <table id="materialsTable">
            <thead>
              <tr>
                <th style="width:32px">#</th>
                <th>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</th>
                <th class="nowrap">Î Î¿ÏƒÏŒÏ„Î·Ï„Î±</th>
                <th class="nowrap">ÎœÎ¿Î½Î¬Î´Î±</th>
                <th class="nowrap right">Î¤Î¹Î¼Î® ÎœÎ¿Î½. (â‚¬)</th>
                <th class="nowrap right">Î“ÏÎ±Î¼Î¼Î® (â‚¬)</th>
                <th>Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td colspan="5" class="right"><strong>Î£ÏÎ½Î¿Î»Î¿ Î¥Î»Î¹ÎºÏÎ½ (â‚¬)</strong></td>
                <td class="right"><span id="materialsSum">0.00</span></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="btns" style="margin-top:8px">
          <button id="addMat" class="ghost">â• Î“ÏÎ±Î¼Î¼Î® Ï…Î»Î¹ÎºÎ¿Ï</button>
          <button id="clearMat" class="ghost">ğŸ§¹ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï…Î»Î¹ÎºÏÎ½</button>
        </div>
      </div>

      <!-- ÎšÏŒÏƒÏ„Î· & Î¦Î Î‘ -->
      <div style="grid-column:span 3">
        <label>ÎšÏŒÏƒÏ„Î¿Ï‚ Î•ÏÎ³Î±ÏƒÎ¯Î±Ï‚ (â‚¬)</label>
        <input type="number" id="labor" step="0.01" min="0" placeholder="0.00">
      </div>
      <div style="grid-column:span 3">
        <label>Î£Ï…Î½Ï„ÎµÎ»ÎµÏƒÏ„Î®Ï‚ Î¦Î Î‘ (%)</label>
        <input type="number" id="vatRate" step="0.5" min="0" placeholder="24">
      </div>
      <div style="grid-column:span 3">
        <label>Î¥Ï€Î¿ÏƒÏÎ½Î¿Î»Î¿ (â‚¬)</label>
        <input type="number" id="subtotal" step="0.01" readonly>
      </div>
      <div style="grid-column:span 3">
        <label>Î¦Î Î‘ (â‚¬)</label>
        <input type="number" id="vatAmount" step="0.01" readonly>
      </div>
      <div style="grid-column:span 3">
        <label>Î£ÏÎ½Î¿Î»Î¿ (â‚¬) Î¼Îµ Î¦Î Î‘</label>
        <input type="number" id="grandTotal" step="0.01" readonly>
      </div>
      <div style="grid-column:span 3">
        <label>Î‘Ï. Î Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÎ¿Ï (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</label>
        <input type="text" id="invoice" placeholder="Ï€.Ï‡. Î¤Î Î¥-123">
      </div>
    </div>

    <div class="btns">
      <button class="primary" id="addBtn">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
      <button id="updateBtn" style="display:none">ğŸ’¾ Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·</button>
      <button class="ghost" id="clearFormBtn">ğŸ§¹ Î•ÎºÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎ· Ï†ÏŒÏÎ¼Î±Ï‚</button>
      <span class="pill" id="status">ÎˆÏ„Î¿Î¹Î¼Î¿</span>
    </div>
  </section>

  <!-- Î›Î¯ÏƒÏ„Î± -->
  <section class="card" style="margin-top:12px">
    <div class="row">
      <div style="grid-column:span 3">
        <label>Î‘Ï€ÏŒ</label>
        <input type="date" id="filterFrom">
      </div>
      <div style="grid-column:span 3">
        <label>ÎˆÏ‰Ï‚</label>
        <input type="date" id="filterTo">
      </div>
      <div style="grid-column:span 3">
        <label>Î ÎµÎ»Î¬Ï„Î·Ï‚ (Ï†Î¯Î»Ï„ÏÎ¿)</label>
        <input type="text" id="filterClient" placeholder="Ï€.Ï‡. Î“Î¹Î¬Î½Î½Î·Ï‚">
      </div>
      <div style="grid-column:span 3">
        <label>ÎšÎµÎ¯Î¼ÎµÎ½Î¿ (Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±/ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚)</label>
        <input type="text" id="filterText" placeholder="Î»Î­Î¾Î·-ÎºÎ»ÎµÎ¹Î´Î¯">
      </div>
    </div>
    <div class="btns">
      <button id="applyFilters">ğŸ” Î•Ï†Î±ÏÎ¼Î¿Î³Î® Ï†Î¯Î»Ï„ÏÏ‰Î½</button>
      <button id="resetFilters" class="ghost">â™»ï¸ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï†Î¯Î»Ï„ÏÏ‰Î½</button>
      <button id="exportCsv" class="ok">â¬‡ï¸ Î•Î¾Î±Î³Ï‰Î³Î® CSV</button>
      <button id="printList" class="warn">ğŸ–¨ï¸ Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</button>
      <button id="backupJson" class="ghost">ğŸ’¾ Î‘Î½Ï„Î¯Î³ÏÎ±Ï†Î¿ (JSON)</button>
      <label class="pill" style="cursor:pointer">ğŸ“¤ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® JSON
        <input id="restoreJson" type="file" accept="application/json" style="display:none">
      </label>
      <span class="pill">Î£ÏÎ½Î¿Î»Î¿ ÎµÎ³Î³ÏÎ±Ï†ÏÎ½: <span id="count">0</span> â€¢ Î£ÏÎ½Î¿Î»Î¿ â‚¬: <span id="sum">0.00</span></span>
    </div>

    <div style="overflow:auto;max-height:50vh;margin-top:8px;border:1px solid var(--border);border-radius:12px">
      <table id="table">
        <thead>
          <tr>
            <th>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th>
            <th>ÎˆÎ½Î±ÏÎ¾Î·</th>
            <th>Î›Î®Î¾Î·</th>
            <th>ÎÏÎµÏ‚</th>
            <th>Î ÎµÎ»Î¬Ï„Î·Ï‚</th>
            <th>Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±</th>
            <th>Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚</th>
            <th>Î•ÏÎ³Î±ÏƒÎ¯Î± (â‚¬)</th>
            <th>Î¥Î»Î¹ÎºÎ¬ (â‚¬)</th>
            <th>Î¥Ï€Î¿ÏƒÏÎ½Î¿Î»Î¿ (â‚¬)</th>
            <th>Î¦Î Î‘ (%)</th>
            <th>Î¦Î Î‘ (â‚¬)</th>
            <th>Î£ÏÎ½Î¿Î»Î¿ (â‚¬)</th>
            <th>Î Î±ÏÎ±ÏƒÏ„.</th>
            <th>Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <div class="sub" style="text-align:center;padding:20px 0 40px">
    Î”ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ Ï„Î¿Ï€Î¹ÎºÎ¬ (localStorage). Î‘Î½ Î±Î»Î»Î¬Î¾ÎµÎ¹Ï‚ Î¼ÏŒÎ½Î¿ ÏÏÎ± Î»Î®Î¾Î·Ï‚/Î­Î½Î±ÏÎ¾Î·Ï‚, Î¿Î¹ ÏÏÎµÏ‚ Ï…Ï€Î¿Î»Î¿Î³Î¯Î¶Î¿Î½Ï„Î±Î¹ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± (Î±Î½ Î· Î»Î®Î¾Î· ÎµÎ¯Î½Î±Î¹ Ï€ÏÎ¹Î½ Î±Ï€ÏŒ Ï„Î·Î½ Î­Î½Î±ÏÎ¾Î· Î¸ÎµÏ‰ÏÎµÎ¯Ï„Î±Î¹ Ï€Î­ÏÎ±ÏƒÎ¼Î± Î¼ÎµÏƒÎ¬Î½Ï…Ï‡Ï„Î¿Ï…).
  </div>
</main>

<script>
  const $$ = s=>document.querySelector(s);
  const $$$ = s=>Array.from(document.querySelectorAll(s));

  const fields = {
    date: $$('#date'), startTime: $$('#startTime'), endTime: $$('#endTime'),
    hours: $$('#hours'), client: $$('#client'), location: $$('#location'),
    task: $$('#task'), labor: $$('#labor'), vatRate: $$('#vatRate'),
    subtotal: $$('#subtotal'), vatAmount: $$('#vatAmount'), grandTotal: $$('#grandTotal'),
    invoice: $$('#invoice')
  };

  const statusEl = $$('#status');
  const tbody = $$('#table tbody');
  const materialsTBody = $$('#materialsTable tbody');
  const materialsSumEl = $$('#materialsSum');
  const countEl = $$('#count');
  const sumEl = $$('#sum');
  const STORAGE_KEY = 'jobs_v4_fix1';

  let data = load();
  let editingIndex = null;

  // Defaults
  fields.date.valueAsDate = new Date();
  fields.vatRate.value = localStorage.getItem('vat_default') || 24;

  function load(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch(e){console.error(e);return[]} }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
  function toNumber(v){ var n=parseFloat(v); return isNaN(n)?0:n; }
  function money(v){ return (toNumber(v)).toFixed(2); }
  function status(msg){ statusEl.textContent = msg; }

  // === Î©Î¡Î•Î£ Î‘Î ÎŸ start/end ===
  function timeToMinutes(t){ if(!t) return null; var parts=t.split(':'); return parseInt(parts[0],10)*60+parseInt(parts[1],10); }
  function minutesToHours(m){ return (m/60).toFixed(2); }
  function calcHoursFromTimes(){
    var s = timeToMinutes(fields.startTime.value);
    var e = timeToMinutes(fields.endTime.value);
    if(s==null || e==null) return; // Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ ÎºÎ±Î¹ Ï„Î± Î´ÏÎ¿
    var diff = e - s;
    if(diff < 0) diff += 24*60; // Ï€Î­ÏÎ±ÏƒÎ¼Î± Î¼ÎµÏƒÎ¬Î½Ï…Ï‡Ï„Î¿Ï…
    fields.hours.value = minutesToHours(diff);
  }

  ;['startTime','endTime'].forEach(function(id){ document.getElementById(id).addEventListener('input', function(){ calcHoursFromTimes(); recalcTotals(); }); });

  // ===== Î¥Î›Î™ÎšÎ‘ =====
  function bindMatRow(tr){
    Array.prototype.forEach.call(tr.querySelectorAll('input'), function(inp){ inp.addEventListener('input', recalcMaterials); });
    tr.querySelector('.del-row').addEventListener('click', function(){ tr.remove(); recalcMaterials(); });
  }

  function addMaterialRow(row){
    var tr = document.createElement('tr');
    var idx = materialsTBody.children.length + 1;
    var qty = row && row.qty != null ? row.qty : 1;
    var unit = row && row.unit ? row.unit : '';
    var price = row && row.price != null ? row.price : 0;
    tr.innerHTML = ''+
      '<td class="nowrap">'+idx+'</td>'+
      '<td><input placeholder="Ï€.Ï‡. ÎšÎ±Î»ÏÎ´Î¹Î¿ 3x2.5" class="mat-desc"/></td>'+
      '<td style="width:110px"><input type="number" min="0" step="0.01" class="mat-qty" value="'+qty+'"/></td>'+
      '<td style="width:120px"><input placeholder="Ï€.Ï‡. m, Ï„Î¼Ï‡" class="mat-unit" value="'+unit+'"/></td>'+
      '<td style="width:140px"><input type="number" min="0" step="0.01" class="mat-price right" value="'+price+'"/></td>'+
      '<td class="right line-total">0.00</td>'+
      '<td><button class="ghost del-row">ğŸ—‘ï¸</button></td>';
    materialsTBody.appendChild(tr);
    if(row && row.desc){ tr.querySelector('.mat-desc').value = row.desc; }
    bindMatRow(tr);
    recalcMaterials();
  }

  function getMaterials(){
    return $$$('#materialsTable tbody tr').map(function(tr){
      return {
        desc: tr.querySelector('.mat-desc').value.trim(),
        qty: toNumber(tr.querySelector('.mat-qty').value),
        unit: tr.querySelector('.mat-unit').value.trim(),
        price: toNumber(tr.querySelector('.mat-price').value)
      };
    }).filter(function(r){ return r.desc || r.qty || r.price; });
  }

  function recalcMaterials(){
    var sum = 0;
    $$$('#materialsTable tbody tr').forEach(function(tr){
      var qty = toNumber(tr.querySelector('.mat-qty').value);
      var price = toNumber(tr.querySelector('.mat-price').value);
      var line = qty * price;
      tr.querySelector('.line-total').textContent = money(line);
      sum += line;
    });
    materialsSumEl.textContent = money(sum);
    recalcTotals();
  }

  // ===== Î£Î¥ÎÎŸÎ›Î‘ & Î¦Î Î‘ =====
  function recalcTotals(){
    var labor = toNumber(fields.labor.value);
    var mats = toNumber(materialsSumEl.textContent);
    var subtotal = labor + mats;
    var vatRate = Math.max(0, toNumber(fields.vatRate.value));
    var vatAmount = subtotal * vatRate / 100;
    fields.subtotal.value = money(subtotal);
    fields.vatAmount.value = money(vatAmount);
    fields.grandTotal.value = money(subtotal + vatAmount);
    localStorage.setItem('vat_default', String(vatRate));
  }

  ;['labor','vatRate'].forEach(function(id){
    document.getElementById(id).addEventListener('input', function(){ recalcMaterials(); recalcTotals(); });
  });

  // ===== CRUD =====
  function clearForm(){
    fields.startTime.value = '';
    fields.endTime.value = '';
    fields.hours.value = '';
    fields.client.value = '';
    fields.location.value = '';
    fields.task.value = '';
    fields.labor.value = '';
    fields.subtotal.value = '';
    fields.vatAmount.value = '';
    fields.grandTotal.value = '';
    fields.invoice.value = '';
    materialsTBody.innerHTML = '';
    addMaterialRow();
    editingIndex = null;
    $$('#addBtn').style.display = '';
    $$('#updateBtn').style.display = 'none';
    status('ÎˆÏ„Î¿Î¹Î¼Î¿');
  }

  function collect(){
    var mats = getMaterials();
    var materialsSum = mats.reduce(function(s,r){ return s + r.qty*r.price; }, 0);
    var subtotal = toNumber(fields.labor.value) + materialsSum;
    var vatRate = Math.max(0, toNumber(fields.vatRate.value));
    var vatAmount = subtotal * vatRate / 100;
    return {
      id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()+Math.random()),
      date: fields.date.value || new Date().toISOString().slice(0,10),
      startTime: fields.startTime.value || '',
      endTime: fields.endTime.value || '',
      hours: money(fields.hours.value),
      client: fields.client.value.trim(),
      location: fields.location.value.trim(),
      task: fields.task.value.trim(),
      materials: mats,
      materialsSum: money(materialsSum),
      labor: money(fields.labor.value),
      subtotal: money(subtotal),
      vatRate: vatRate,
      vatAmount: money(vatAmount),
      total: money(subtotal + vatAmount),
      invoice: fields.invoice.value.trim()
    };
  }

  function validate(rec){ if(!rec.client) return 'Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î¿Î½ Ï€ÎµÎ»Î¬Ï„Î·'; if(!rec.task) return 'Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î¹Ï‚ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚'; return null; }

  function add(){
    var rec = collect();
    var err = validate(rec); if(err){ alert(err); return; }
    data.push(rec); save(); status('Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ âœ…'); render(); clearForm();
  }

  function startEdit(id){
    var idx = data.findIndex(function(r){ return r.id === id; }); if(idx===-1) return; var r = data[idx]; editingIndex = idx;
    fields.date.value = r.date; fields.startTime.value = r.startTime || ''; fields.endTime.value = r.endTime || '';
    fields.hours.value = r.hours; fields.client.value = r.client; fields.location.value = r.location; fields.task.value = r.task; fields.labor.value = r.labor; fields.vatRate.value = r.vatRate != null ? r.vatRate : (localStorage.getItem('vat_default')||24); fields.subtotal.value = r.subtotal; fields.vatAmount.value = r.vatAmount; fields.grandTotal.value = r.total; fields.invoice.value = r.invoice || '';
    materialsTBody.innerHTML=''; (r.materials||[]).forEach(function(row){ addMaterialRow(row); }); if((r.materials||[]).length===0) addMaterialRow();
    $$('#addBtn').style.display = 'none'; $$('#updateBtn').style.display = '';
    status('Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚â€¦'); window.scrollTo({top:0, behavior:'smooth'});
    recalcMaterials();
  }

  function update(){ if(editingIndex===null) return; var rec = collect(); rec.id = data[editingIndex].id; var err = validate(rec); if(err){ alert(err); return; } data[editingIndex] = rec; save(); status('Î•Î½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ ğŸ’¾'); render(); clearForm(); }

  function remove(id){ if(!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚;')) return; data = data.filter(function(r){ return r.id !== id; }); save(); render(); status('Î”Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ ğŸ—‘ï¸'); }

  // ===== Î Î™ÎÎ‘ÎšÎ‘Î£ =====
  function filtered(){
    var fFrom = $$('#filterFrom').value; var fTo = $$('#filterTo').value; var fClient = ($$('#filterClient').value||'').trim().toLowerCase(); var fText = ($$('#filterText').value||'').trim().toLowerCase();
    return data.filter(function(r){
      if(fFrom && r.date < fFrom) return false; if(fTo && r.date > fTo) return false; if(fClient && r.client.toLowerCase().indexOf(fClient)===-1) return false; if(fText && (r.location+' '+r.task).toLowerCase().indexOf(fText)===-1) return false; return true;
    }).sort(function(a,b){ return a.date.localeCompare(b.date); });
  }

  function addRow(rec){
    var tr = document.createElement('tr');
    var cells = [rec.date, rec.startTime||'â€”', rec.endTime||'â€”', rec.hours, rec.client, rec.location, rec.task, money(rec.labor), money(rec.materialsSum), money(rec.subtotal), rec.vatRate+'%', money(rec.vatAmount), money(rec.total), rec.invoice || 'â€”'];
    cells.forEach(function(c){ var td=document.createElement('td'); td.textContent=c; tr.appendChild(td); });
    var tdAct = document.createElement('td'); var e = document.createElement('button'); e.textContent='âœï¸'; e.className='ghost'; var d = document.createElement('button'); d.textContent='ğŸ—‘ï¸'; d.className='ghost'; e.addEventListener('click', function(){ startEdit(rec.id); }); d.addEventListener('click', function(){ remove(rec.id); }); tdAct.appendChild(e); tdAct.appendChild(document.createTextNode(' ')); tdAct.appendChild(d); tr.appendChild(tdAct);
    tbody.appendChild(tr);
  }

  function render(){ tbody.innerHTML=''; var items = filtered(); items.forEach(addRow); countEl.textContent = items.length; var sum = items.reduce(function(s,r){ return s + toNumber(r.total); }, 0); sumEl.textContent = sum.toFixed(2); }

  function applyFilters(){ render(); status('Î•Ï†Î±ÏÎ¼ÏŒÏƒÏ„Î·ÎºÎ±Î½ Ï†Î¯Î»Ï„ÏÎ±'); }
  function resetFilters(){ ['#filterFrom','#filterTo','#filterClient','#filterText'].forEach(function(s){ $$(s).value=''; }); render(); status('ÎšÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎ±Î½ Ï†Î¯Î»Ï„ÏÎ±'); }

  // ===== Î•ÎÎ‘Î“Î©Î“Î•Î£ =====
  function downloadFile(filename, mime, content){ var blob = new Blob([content], {type:mime}); var url = URL.createObjectURL(blob); var a = document.createElement('a'); a.href=url; a.download=filename; a.click(); setTimeout(function(){ URL.revokeObjectURL(url); }, 0); }

  function csvEscape(s){ return '"'+String(s).replace(/"/g,'""')+'"'; }

  function exportCsv(){
    var rows = [[ 'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±','ÎÏÎ± ÎˆÎ½Î±ÏÎ¾Î·Ï‚','ÎÏÎ± Î›Î®Î¾Î·Ï‚','ÎÏÎµÏ‚','Î ÎµÎ»Î¬Ï„Î·Ï‚','Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±','Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚','Î•ÏÎ³Î±ÏƒÎ¯Î± (â‚¬)','Î¥Î»Î¹ÎºÎ¬ (â‚¬)','Î¥Ï€Î¿ÏƒÏÎ½Î¿Î»Î¿ (â‚¬)','Î¦Î Î‘ (%)','Î¦Î Î‘ (â‚¬)','Î£ÏÎ½Î¿Î»Î¿ (â‚¬)','Î Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÏŒ','Î¥Î»Î¹ÎºÎ¬ (Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬)']];
    filtered().forEach(function(r){
      var mats = (r.materials||[]).map(function(m){ return m.desc+' x'+m.qty+' '+m.unit+' @'+money(m.price)+'â‚¬ = '+money(m.qty*m.price)+'â‚¬'; }).join(' | ');
      rows.push([r.date,r.startTime||'',r.endTime||'',r.hours,r.client,r.location,r.task,r.labor,r.materialsSum,r.subtotal,r.vatRate,r.vatAmount,r.total,r.invoice||'', mats]);
    });
    var csv = rows.map(function(row){ return row.map(csvEscape).join(','); }).join('\n');
    downloadFile('Î´Î¿Ï…Î»ÎµÎ¹Î­Ï‚.csv','text/csv;charset=utf-8;',csv); status('Î•Î¾Î®Ï‡Î¸Î· CSV â¬‡ï¸');
  }

  function backupJson(){ downloadFile('jobs-backup.json','application/json', JSON.stringify(data,null,2)); status('Î‘Î½Ï„Î¯Î³ÏÎ±Ï†Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ğŸ’¾'); }
  function restoreJson(ev){ var f = ev.target.files && ev.target.files[0]; if(!f) return; var reader = new FileReader(); reader.onload = function(){ try{ var arr = JSON.parse(reader.result); if(!Array.isArray(arr)) throw new Error('bad'); data = arr; save(); render(); status('Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ âœ…'); }catch(e){ alert('ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ Î±ÏÏ‡ÎµÎ¯Î¿ JSON'); } }; reader.readAsText(f); ev.target.value=''; }

  function printList(){ var w = window.open('','_blank'); var rows = filtered(); var style = 'body{font-family:system-ui,Segoe UI,Arial;padding:24px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ddd;padding:6px 8px;font-size:12px} th{background:#f3f4f6}'; w.document.write('<html><head><title>Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</title><style>'+style+'</style></head><body>'); w.document.write('<h2>Î›Î¯ÏƒÏ„Î± Î”Î¿Ï…Î»ÎµÎ¹ÏÎ½</h2>'); w.document.write('<table><thead><tr><th>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th><th>ÎˆÎ½Î±ÏÎ¾Î·</th><th>Î›Î®Î¾Î·</th><th>ÎÏÎµÏ‚</th><th>Î ÎµÎ»Î¬Ï„Î·Ï‚</th><th>Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±</th><th>Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚</th><th>Î•ÏÎ³Î±ÏƒÎ¯Î± (â‚¬)</th><th>Î¥Î»Î¹ÎºÎ¬ (â‚¬)</th><th>Î¥Ï€Î¿ÏƒÏÎ½Î¿Î»Î¿</th><th>Î¦Î Î‘</th><th>Î£ÏÎ½Î¿Î»Î¿</th><th>Î Î±ÏÎ±ÏƒÏ„.</th></tr></thead><tbody>'); rows.forEach(function(r){ w.document.write('<tr><td>'+r.date+'</td><td>'+(r.startTime||'')+'</td><td>'+(r.endTime||'')+'</td><td>'+r.hours+'</td><td>'+r.client+'</td><td>'+r.location+'</td><td>'+r.task+'</td><td>'+r.labor+'</td><td>'+r.materialsSum+'</td><td>'+r.subtotal+'</td><td>'+r.vatRate+'% ('+r.vatAmount+'â‚¬)</td><td>'+r.total+'</td><td>'+(r.invoice||'')+'</td></tr>'); }); var sum = rows.reduce(function(s,r){ return s + (parseFloat(r.total)||0); }, 0).toFixed(2); w.document.write('<tfoot><tr><td colspan="11" style="text-align:right"><strong>Î£ÏÎ½Î¿Î»Î¿ (â‚¬):</strong></td><td colspan="2"><strong>'+sum+'</strong></td></tr></tfoot>'); w.document.write('</tbody></table></body></html>'); w.document.close(); w.focus(); w.print(); }

  // === Events ===
  $$('#addMat').addEventListener('click', function(){ addMaterialRow(); });
  $$('#clearMat').addEventListener('click', function(){ if(confirm('ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Ï…Î»Î¹ÎºÏÎ½;')){ materialsTBody.innerHTML=''; addMaterialRow(); recalcMaterials(); }});
  $$('#addBtn').addEventListener('click', add);
  $$('#updateBtn').addEventListener('click', update);
  $$('#clearFormBtn').addEventListener('click', clearForm);
  $$('#applyFilters').addEventListener('click', applyFilters);
  $$('#resetFilters').addEventListener('click', resetFilters);
  $$('#exportCsv').addEventListener('click', exportCsv);
  $$('#printList').addEve
</body>
</html>
